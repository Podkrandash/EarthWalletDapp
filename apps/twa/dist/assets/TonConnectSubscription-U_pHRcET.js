import{eD as h,eE as g,eF as v,r,c as C,bo as I,eG as D,eH as N,ah as x,eI as q,eJ as B,eK as O,eL as K,eM as P,eN as j,eO as J,j as l,eP as W,aD as k}from"./index-5ZbQ4RqH.js";const L=async({connection:e,request:{id:n,method:a}})=>{await h({response:v(n,a),sessionKeyPair:e.sessionKeyPair,clientSessionId:e.clientSessionId})},S=async({connection:e,request:{id:n}})=>{await h({response:g(n),sessionKeyPair:e.sessionKeyPair,clientSessionId:e.clientSessionId})},_=()=>k(L),b="TK_WEB::TON_CONNECT",G=()=>{var A;const[e,n]=r.useState(void 0),a=C(),w=I(),{data:t}=D(),{data:f}=N(),{mutateAsync:y}=x(),{mutate:p}=_(),{mutateAsync:T}=q();B((A=e==null?void 0:e.connection)==null?void 0:A.manifest);const{mutateAsync:E}=O();r.useEffect(()=>{const o=s=>{switch(s.request.method){case"disconnect":return y(s.connection).then(()=>S({...s}));case"sendTransaction":{n(void 0);const i={connection:s.connection,id:s.request.id,payload:JSON.parse(s.request.params[0])},d=t==null?void 0:t.find(R=>R.connections.some(m=>m.clientSessionId===s.connection.clientSessionId));d?E(d.wallet.rawAddress).then(()=>setTimeout(()=>{n(i)},100)):setTimeout(()=>{n(i)},100);return}default:return p(s)}},{notifications:c}=a;(async()=>{if(c&&t)try{if(await c.subscribed(w.rawAddress))for(const i of t.flatMap(d=>d.connections))await c.subscribeTonConnect(i.clientSessionId,new URL(i.manifest.url).host)}catch(s){s instanceof Error&&a.topMessage(s.message)}})();const u=K({storage:a.storage,handleMessage:o,connections:t==null?void 0:t.flatMap(s=>s.connections),lastEventId:f});return()=>{u()}},[a,t,f,y,n,p]);const M=r.useCallback(async o=>{if(e){try{await T({request:e,boc:o})}finally{n(void 0)}P(b,JSON.stringify({event:"close-tx-confirmation",id:e.id}))}},[e,T,n]);return r.useEffect(()=>{if(e)return j(b,o=>{const c=JSON.parse(o);c.id===e.id&&c.event==="close-tx-confirmation"&&n(void 0)})},[e]),r.useEffect(()=>J.subscribe(o=>{(Array.isArray(o)?o:[o]).forEach((u,s)=>S({connection:u,request:{id:(Date.now()+s).toString()}}))}),[]),l.jsx(l.Fragment,{children:l.jsx(W,{params:(e==null?void 0:e.payload)??null,handleClose:M})})};export{G as default};
